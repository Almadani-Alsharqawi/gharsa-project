# Root Nginx Gateway Configuration for JPAAS Deployment
# Routes traffic based on subdomain to appropriate services

# Main nginx configuration context
events {
    worker_connections 1024;
}

http {
    # Basic settings
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logging format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # Upstream definitions for backend services
    upstream backend {
        server backend:1337;
    }

    upstream frontend-view {
        server frontend-view:80;
    }

    upstream frontend-admin {
        server frontend-admin:80;
    }

    # Main server block for gharsa.ly (view frontend)
    server {
        listen 80;
        server_name gharsa.ly;

        # Logging
        access_log /var/log/nginx/gharsa-view.access.log main;
        error_log /var/log/nginx/gharsa-view.error.log;

        # Root location - serve frontend-view
        location / {
            proxy_pass http://frontend-view;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support (if needed)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Server block for admin.gharsa.ly (admin frontend)
    server {
        listen 80;
        server_name admin.gharsa.ly;

        # Logging
        access_log /var/log/nginx/gharsa-admin.access.log main;
        error_log /var/log/nginx/gharsa-admin.error.log;

        # Root location - serve frontend-admin
        location / {
            proxy_pass http://frontend-admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support (if needed)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Server block for strapi.gharsa.ly (backend API)
    server {
        listen 80;
        server_name strapi.gharsa.ly;

        # Logging
        access_log /var/log/nginx/strapi.access.log main;
        error_log /var/log/nginx/strapi.error.log;

        # Increase body size for file uploads
        client_max_body_size 100M;

        # Root location - proxy to Strapi backend
        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Critical SSL and cookie fix headers
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;
            
            # WebSocket support for Strapi admin
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Timeouts for long-running requests
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Handle uploads directory directly (optional optimization)
        location /uploads/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;
        }
    }
}

