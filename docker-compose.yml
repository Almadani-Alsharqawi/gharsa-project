version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gharsa-backend
    restart: unless-stopped
    expose:
      - "1337"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=1337
      - APP_KEYS=${APP_KEYS}
      - API_TOKEN_SALT=${API_TOKEN_SALT}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
      - TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USERNAME=${DATABASE_USERNAME}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_SSL=${DATABASE_SSL:-false}
    volumes:
      - backend-uploads:/app/public/uploads
    networks:
      - dokploy-network
    labels:
      - "traefik.http.services.backend.loadbalancer.server.port=1337"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:1337/api', (r) => {process.exit(r.statusCode === 200 || r.statusCode === 401 ? 0 : 1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend-view:
    build:
      context: ./frontend-view
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://strapi.gharsa.ly
    container_name: gharsa-frontend-view
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - dokploy-network
    labels:
      - "traefik.http.services.frontend-view.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend-admin:
    build:
      context: ./frontend-admin
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://strapi.gharsa.ly
    container_name: gharsa-frontend-admin
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - dokploy-network
    labels:
      - "traefik.http.services.frontend-admin.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  backend-uploads:
    driver: local

networks:
  dokploy-network:
    external: true
