version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gharsa-backend
    restart: unless-stopped
    expose:
      - "1337"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=1337
      - APP_KEYS=${APP_KEYS}
      - API_TOKEN_SALT=${API_TOKEN_SALT}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
      - TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USERNAME=${DATABASE_USERNAME}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_SSL=${DATABASE_SSL:-false}
      - STRAPI_URL=https://strapi.gharsa.ly
      - STRAPI_ADMIN_URL=https://strapi.gharsa.ly/admin
      - STRAPI_PROXY=true
    volumes:
      - backend-uploads:/app/public/uploads
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gharsa-backend.rule=Host(`strapi.gharsa.ly`)"
      - "traefik.http.routers.gharsa-backend.entrypoints=websecure"
      - "traefik.http.routers.gharsa-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=1337"
      - "traefik.http.routers.gharsa-backend.middlewares=strapi-headers"
      - "traefik.http.middlewares.strapi-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.strapi-headers.headers.customrequestheaders.X-Forwarded-Host=strapi.gharsa.ly"

  frontend-view:
    build:
      context: ./frontend-view
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://strapi.gharsa.ly
    container_name: gharsa-frontend-view
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gharsa-view.rule=Host(`gharsa.ly`)"
      - "traefik.http.routers.gharsa-view.entrypoints=websecure"
      - "traefik.http.routers.gharsa-view.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend-view.loadbalancer.server.port=80"

  frontend-admin:
    build:
      context: ./frontend-admin
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://strapi.gharsa.ly
    container_name: gharsa-frontend-admin
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gharsa-admin.rule=Host(`admin.gharsa.ly`)"
      - "traefik.http.routers.gharsa-admin.entrypoints=websecure"
      - "traefik.http.routers.gharsa-admin.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend-admin.loadbalancer.server.port=80"

volumes:
  backend-uploads:
    driver: local

networks:
  dokploy-network:
    external: true
